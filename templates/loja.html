<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cronos - Categorias</title>
  <link rel="icon" href="{{url_for('static', filename='img/cronos_logo_neon_transparent-removebg-preview.png')}}">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
    crossorigin="anonymous">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/loja.css') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/particula.css') }}">
</head>

<body>
  <div class="container-principal">
    <div class="particles" id="particles"></div>

    <header class="header">
      <div class="logo-container">
        <img src="{{ url_for('static', filename='img/cronos_logo_neon_transparent-removebg-preview.png') }}" alt="logo"
          width="50">
        <h1>Cronos</h1>
      </div>

      <!-- Ícone burger para mobile -->
      <img
        src="{{ url_for('static', filename='img/1000_F_225221877_9x7repcZzz4ryhvZ4Z5DmlnnCTdTUImT-removebg-preview.png') }}"
        alt="Menu" class="menu-burger-icon" id="burgerBtn">

      <nav class="nav" id="mainNav" aria-label="Navegação principal">
        <a href="{{ url_for('index') }}"><button class="nav-button">Home</button></a>
        <a href="{{ url_for('biblioteca') }}"><button class="nav-button">Biblioteca</button></a>
        <a href="{{ url_for('loja') }}"><button class="nav-button active">Loja</button></a>
        <a href="{{ url_for('suporte') }}"><button class="nav-button">Suporte</button></a>
        {% if session.get('user_role') == 'dev' or session.get('user_role') == 'admin' %}
        <a href="{{ url_for('dev_upload') }}"><button class="nav-button">Dev</button></a>
        {% endif %}
        {% if session.get('user_role') == 'admin' %}
        <a href="{{ url_for('admin_index') }}"><button class="nav-button">Admin</button></a>
        {% endif %}
      </nav>

      <div class="perfil" role="button" aria-haspopup="true" aria-expanded="false" id="perfilBtn">
        <div class="avatar" aria-hidden="true">
          {% if session.get('user_avatar') %}
          <img src="/{{ session.get('user_avatar') }}" alt="Avatar">
          {% else %}
          <img src="{{ url_for('static', filename='img/default-avatar.png') }}" alt="Avatar">
          {% endif %}
        </div>
        <span>
          {% if session.get('user_id') %}
          {{ session.get('user_nick') or session.get('user_name') }}
          {% else %} PERFIL {% endif %}
        </span>
      </div>

      <div class="profile-menu" id="profileMenu">
        <div class="profile-header">
          <div class="profile-avatar">
            {% if session.get('user_avatar') %}
            <img src="/{{ session.get('user_avatar') }}" alt="Avatar do usuário">
            {% else %}
            <img src="{{ url_for('static', filename='img/default-avatar.png') }}" alt="Avatar padrão">
            {% endif %}
          </div>
          <div class="profile-info">
            <h4>
              {% if session.get('user_id') %}
              {{ session.get('user_nick') or session.get('user_name') }}
              {% else %}
              Usuário Cronos
              {% endif %}
            </h4>
            <p>
              {% if session.get('user_id') %}
              Nível {{ session.get('user_level', 1) }}
              {% else %}
              Nível 1
              {% endif %}
            </p>
          </div>
        </div>
        <div class="profile-actions">
          {% if session.get('user_id') %}
          <a class="profile-action-btn" href="{{ url_for('perfilConfig') }}">Meu Perfil</a>
          <a class="profile-action-btn" href="{{ url_for('perfilConfig') }}">Configurações</a>
          <a class="profile-action-btn" href="{{ url_for('logout', next=request.full_path or request.path) }}">Sair</a>
          <a href="{{ url_for('politicas') }}" class="profile-action-btn">Políticas</a>
          {% else %}
          <a class="profile-action-btn" href="{{ url_for('login') }}">Entrar</a>
          <a class="profile-action-btn" href="{{ url_for('cadastrar') }}">Cadastrar</a>
          <a class="profile-action-btn" href="{{ url_for('perfilConfig') }}">Configurações</a>
          <a href="{{ url_for('politicas') }}" class="profile-action-btn">Políticas</a>
          {% endif %}
        </div>
      </div>
    </header>

    <!-- Botão de categorias (mobile) -->
    <button id="toggleCatDrawer" class="cat-toggle-btn" type="button" aria-expanded="false" aria-controls="catDrawer">
      Categorias
    </button>

    <aside class="cat-drawer" id="catDrawer" aria-label="Categorias de jogos">
      <div class="cat-drawer-header">Categorias</div>
      <div class="cat-drawer-body" id="catListDrawer">
        <button class="cat-pill active" data-cat="all">Todas</button>
        {# categorias únicas #}
        {% set _cats = [] %}
        {% for g in games %}
        {% if g.categoria and g.categoria not in _cats %}
        {% set __ = _cats.append(g.categoria) %}
        {% endif %}
        {% endfor %}
        {% for c in _cats %}
        <button class="cat-pill" data-cat="{{ c|lower }}">{{ c }}</button>
        {% endfor %}
      </div>
    </aside>

    <main>
      <div class="container game-gallery-container">
        <h2>Loja</h2>
        <div class="row">
          <div class="col-12">
            <div class="row g-4" id="game-gallery">
              {% for g in games %}
              <div class="col-12 col-md-6 col-lg-6 col-xxl-4 game-card" data-id="{{ g.id }}" data-title="{{ g.titulo }}"
                data-desc="{{ g.descricao or '' }}" data-cover="{{ g.capa_url }}"
                data-trailer="{{ g.trailer_url or '' }}" data-category="{{ g.categoria }}"
                data-price="{{ '%.2f'|format(g.preco) }}" data-buildslug="{{ g.build_slug or '' }}"
                data-owned="{% if g.id in owned_ids %}1{% else %}0{% endif %}"
                data-free="{% if g.preco|float <= 0 %}1{% else %}0{% endif %}" data-images="{{ g._data_images }}"
                data-videos="{{ g._data_videos }}">
                <div class="card">
                  <img src="{{ g.capa_url }}" class="card-img-top" alt="Capa do jogo">
                  <div class="card-body d-flex flex-column">
                    <h5 class="card-title">{{ g.titulo }}</h5>
                    {% if g.descricao %}
                    <p class="card-text">{{ g.descricao }}</p>
                    {% endif %}
                    <div class="mt-auto pt-2">
                      <span class="badge bg-purple">{{ g.categoria }}</span>
                      {% if g.preco|float <= 0 %} <span class="badge bg-purple">Grátis</span>
                        {% else %}
                        <span class="badge bg-purple">R$ {{ '%.2f'|format(g.preco) }}</span>
                        {% endif %}
                        <button class="bg-green comprar-btn" data-game-id="{{ g.id }}"
                          data-price="{{ '%.2f'|format(g.preco) }}" {% if g.id in owned_ids %}disabled{% endif %}>
                          {% if g.id in owned_ids %}
                          Adquirido
                          {% elif g.preco|float <= 0 %} Obter {% else %} Comprar {% endif %} </button>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            <div id="no-results" class="no-results hidden">Nenhum jogo nesta categoria.</div>
          </div>
        </div>
      </div>
    </main>

    <div id="overlay" class="overlay" aria-hidden="true"></div>

    <aside id="paymentDrawer" class="payment-drawer" aria-hidden="true" aria-label="Pagamento">
      <div class="payment-header">
        <div class="header-title">
          <div class="muted">Comprar</div>
          <div id="drawerGameTitle" style="font-weight:600;">—</div>
        </div>
        <button id="closeDrawerBtn" class="payment-close" aria-label="Fechar">✕</button>
      </div>
      <div class="payment-body">
        <div class="muted">
          <p>Selecione o meio de pagamento</p>
        </div>
        <div class="method-option" id="optPaypal">
          <img src="https://www.paypalobjects.com/webstatic/icon/pp258.png" width="28" height="28" alt="PayPal">
          <div>
            <div style="font-weight:600;">PayPal</div>
            <div class="muted">Cartão/crédito via PayPal</div>
          </div>
        </div>
      </div>
      <div id="paypalSection" class="hidden">
        <div class="muted">Finalize com PayPal:</div>
        <div id="paypal-button-container"></div>
      </div>
      <div id="pixSection" class="hidden">
        <div class="qr-box">
          <img id="pixQrImage" src="" alt="QR Code PIX" class="hidden">
          <div class="copy-row">
            <input id="pixCopy" type="text" readonly value="">
            <button id="copyPixBtn" type="button">Copiar</button>
          </div>
          <div id="pixStatus" class="muted">Aguardando geração do PIX…</div>
          <button id="genPixBtn" class="ok" type="button">Gerar PIX</button>
        </div>
      </div>
      <div class="payment-footer">
        <button class="cancel" id="cancelPaymentBtn" type="button">Cancelar</button>
        <button class="ok" id="finishLaterBtn" type="button">Finalizar depois</button>
      </div>
    </aside>

    <div id="gameDetailsModal" class="gmodal" aria-hidden="true" role="dialog" aria-labelledby="gmodalTitle">
      <div class="gmodal__overlay" data-close></div>
      <div class="gmodal__dialog">
        <button class="gmodal__close" aria-label="Fechar" data-close>X</button>
        <div class="gmodal__media" id="gmodalMedia">
          <div class="gmodal__stage" id="gmodalStage">
            <button class="gmodal__nav gmodal__nav--prev" data-nav="prev" aria-label="Anterior">‹</button>
            <button class="gmodal__nav gmodal__nav--next" data-nav="next" aria-label="Próximo">›</button>
          </div>
          <div class="gmodal__rail">
            <div class="gmodal__thumbs" id="gmodalThumbs"></div>
          </div>
        </div>
        <div class="gmodal__body">
          <div class="gmodal__thumbwrap">
            <img id="gmodalSmallCover" alt="Capa do jogo">
          </div>
          <div class="gmodal__header">
            <h3 id="gmodalTitle">-</h3>
            <div class="gmodal__tags" id="gmodalTags"></div>
          </div>
          <p id="gmodalDesc" class="gmodal__desc">-</p>
          <div class="gmodal__meta" id="gmodalMeta" hidden></div>
          <div class="gmodal__actions">
            <a id="gmodalPlay" class="btn btn-cta" href="#" hidden>Ir para a loja</a>
            <button id="gmodalBuy" class="btn btn-cta" type="button">Comprar</button>
            <button id="gmodalWishlist" class="btn btn-ghost" type="button">Wishlist</button>
            {% if session.get('user_role') == 'admin' %}
            <button id="gmodalDelete" class="btn btn-ghost btn-danger-modal" type="button">Excluir jogo</button>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

  </div>

  <script>
    window.CRONOS_USER_ROLE = "{{ session.get('user_role', 'user') }}";
  </script>


  <script src="{{ url_for('static', filename='js/loja.js') }}"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"></script>
  <script
    src="https://www.paypal.com/sdk/js?client-id=AaEpAmYBZ4ov5PXNrCZFlk5enYB5MPRcO44oY8hJwm4_kXChYdXXFDit1egY9BsF1nBlDBPpKOq6w7_y&currency=BRL"
    data-sdk-integration-source="button-factory"></script>
  <script src="{{ url_for('static', filename='js/particula.js') }}"></script>
</body>

</html>